<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gfit: Galaxy Shape Measurement</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">gfit&#160;<span id="projectnumber">1.0.0</span></div>
   <div id="projectbrief">Galaxy Shape Measurement</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('index.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Galaxy Shape Measurement </h1>  </div>
</div>
<div class="contents">
<div class="textblock"><p>Author: Marc Gentile (<a href="mailto:marc.gentile@epfl.ch">marc.gentile@epfl.ch</a>) </p>
<h2><a class="anchor" id="Description"></a>
Description</h2>
<p>The <code>gfit</code> method uses a forward model fitting algorithm to measure galaxy shapes.</p>
<p>An earlier version of gfit, used to participate in the <code>GREAT10</code> galaxy Challenge (Kitching et al., 2011, Applied Statistics, Kitching et al, 2012, MNRAS), has been described in Gentile et al, 2012, astro-ph/1211.4847 (<a href="http://arxiv.org/abs/1211.4847">http://arxiv.org/abs/1211.4847</a>).</p>
<p>The present version has been customized to participate in the <code>GREAT3</code> Challenge (<a href="http://great3.projects.phys.ucl.ac.uk/leaderboard/">http://great3.projects.phys.ucl.ac.uk/leaderboard/</a>).</p>
<p>The following galaxy models are currently supported:</p>
<ul>
<li><code>scsersic:</code> an implementation of galaxy model base on a pure disk Sérsic model (<a href="http://en.wikipedia.org/wiki/Sersic_profile">http://en.wikipedia.org/wiki/Sersic_profile</a>)</li>
<li><code>gbdsersic:</code> an implementation of galaxy model based on the combination of an exponential Sérsic profile (sersic index 1) to model the galaxy disk and a de Vaucouleur Sérsic profile (Sérsic index 4) to model the galaxy bulge. Both the disk and the bulge share the same centroid and the same elipticity. The shear estimator is the distortion |e| = (a^2 - b^2)/(a^2 + b^2). The underlying implementation is done using <code>GalSim</code> v1.x, the "modular galaxy image simulation toolkit", see <a href="https://github.com/GalSim-developers/GalSim.">https://github.com/GalSim-developers/GalSim.</a></li>
<li><code>gbdshsersic:</code> </li>
<li><code>gbdshsersic:</code> an implementation of galaxy model identical to that of <code>gbdsersic</code> except that the reduced shear |g| = (a - b)/(a + b) is used insead of the distortion |e|.</li>
<li><code>gcbdsersic:</code> an implementation of galaxy model identical to that of <code>gbdsersic</code> but with a varying disk Sérsic index.</li>
<li><code>gccbdsersic:</code> an implementation of galaxy model identical to that of gcbdsersic except that the disk and the bulge Sérsic index can also vary.</li>
</ul>
<p>Fitting can currently be performed using two minimizers:</p>
<ul>
<li><code>scileastsq:</code> based on the <code>Levenberg-Marquardt</code> non-linear least-squares implementation, available with the Python SciPy library (<a href="http://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.leastsq.html">http://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.leastsq.html</a>))</li>
<li><code>scdmin:</code> a wrapper to SCDM (Simple Coordinate Descent Minimizer, M. Gentile, 2011-2013) an implementation of the Coordinate Descent algorithm (<a href="http://en.wikipedia.org/wiki/Coordinate_descent">http://en.wikipedia.org/wiki/Coordinate_descent</a>).</li>
</ul>
<p><code>gfit</code> is written in <code>Python</code> (<a href="http://www.python.org/">http://www.python.org/</a>) and takes advantage of the language flexibility and richness of features. It relies heavily on the <code>numpy</code> and <code>scipy</code> <code>Python</code> C/C++/fortran libraries.</p>
<p>The software has been designed in such a way that additional galaxy models and minimizers can be plugged-in fairly quickly.</p>
<p>The implementation of this version relies mainly on the following modules:</p>
<ul>
<li>../../mpf_package/mpf (Multi-Processing Framework, M. Gentile, 2013): a Python module for executing code on both SMP (Symmetric Multiprocessing) or on serveurs supporting the Message Passing Interface (MPI). Refer to the documentation of <code>mpf</code> module for additional details.</li>
<li><code>mpfg3</code> (M. Gentile, 2013): an extension of <code>mpf</code> that provides an adaptation layer to access the <code>GREAT3</code> datasets. Refer to the documentation of <code>mpfg3</code> module for additional details.</li>
<li><code>multifit</code> (MulTipurpose Fitting framework, M. Gentile, 2013): a python module that offers a common fitting interface to different parametric models and fitting algorithms. Refer to the documentation of <code>Multifit</code> for additional details.</li>
<li><code>scdm</code> (Simple Coordinate Descent Minimizer, M. Gentile, 2011-2013) an implementation of the Coordinate Descent algorithm (<a href="http://en.wikipedia.org/wiki/Coordinate_descent">http://en.wikipedia.org/wiki/Coordinate_descent</a>).</li>
<li>Numpy v1.7.x., SciPy v0.9.x and pyfits Python modules</li>
</ul>
<h2><a class="anchor" id="code"></a>
Source code</h2>
<p>The source code is organized as follows:</p>
<ul>
<li>Configuration files:<ul>
<li><code>config/gfit.cfg</code> (or any other name), containing the top <code>gfit</code> configuration parameters.</li>
</ul>
</li>
</ul>
<ul>
<li>config/models: configuration for model: <code>scsersic</code>, <code>gbdsersic</code>, <code>gcbdsersic</code> <ul>
<li><code>scsersic.cfg</code> </li>
</ul>
</li>
<li>config/methods: configuration for methods: <code>scdmin</code> and <code>scileastsq</code> <ul>
<li><code>scileastsq.cfg</code> </li>
<li><code>scdmin.cfg</code> </li>
</ul>
</li>
<li>config/fitting: extra fitting configuration that combine model and method information. At present, only the <code>scdmin</code> method uses such configuration.<ul>
<li><code>scdmin_fitting.cfg:</code> extra configuration for <code>scdmin:</code> <code>scsersic</code>, <code>gbdsersic</code>, <code>gcbdsersic</code> </li>
</ul>
</li>
</ul>
<ul>
<li>Python code:<ul>
<li><code><a class="el" href="gfit__MPI_8py.html">gfit_MPI.py</a>:</code> main entry point of the MPI executable</li>
<li><code><a class="el" href="gfit__SMP_8py.html">gfit_SMP.py</a>:</code> main entry point of the SMP executable</li>
<li><code><a class="el" href="gfit__args_8py.html">gfit_args.py</a>:</code> handle command-line arguments and options</li>
<li><code><a class="el" href="gfit__helper_8py.html">gfit_helper.py</a>:</code> helper class</li>
<li><code><a class="el" href="namespacegfit_1_1gfit__job.html" title="Job Processing.">gfit_job</a>:</code> job handling, specializations of job handling classes available from <code>mpf</code> and <code>mpfg3</code> </li>
<li><code><a class="el" href="namespacegfit_1_1gfit__shape.html" title="Galaxy shape estimator.">gfit_shape</a>:</code> shape measurement</li>
<li><code><a class="el" href="namespacegfit_1_1gfit__filter.html" title="Object filtering.">gfit_filter</a>:</code> object filtering</li>
<li><code><a class="el" href="namespacegfit_1_1gfit__plot.html" title="Plotting functions.">gfit_plot</a>:</code> plotting classes</li>
<li><code><a class="el" href="namespacegfit_1_1gfit__version.html" title="Set the package version.">gfit_version</a>:</code> version information</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="Prerequisites"></a>
Prerequisites</h2>
<ul>
<li>Mandatory:</li>
</ul>
<ul>
<li><code>Python</code> 2.6 or 2.7 on Unix or Mac OS</li>
<li><code>Numpy</code> v1.7.x, Scipy v0.9.x, Pyfits v3.1.x, Matplotlib 1.2.1 or greater</li>
<li><code>mpfg</code> v1.x or greater: base multiprocessing framework</li>
<li><code>mpfx</code> v1.x or greater: adaptation of mpf for the GREAT3 dataset</li>
<li><code>multifit</code> v1.x, MulTipurpose Fitting framework</li>
<li><code>sconfig</code> v1.x: configuration file parser module</li>
<li><code>slogger</code> v1.x: logging module</li>
<li><code>scatalog</code> v1.x: catalog management for astronomical data Note that this module also requires the following:<ul>
<li><code>pyfits</code> v3.1.x (<a href="http://www.stsci.edu/institute/software_hardware/pyfits">http://www.stsci.edu/institute/software_hardware/pyfits</a>)</li>
<li><code>AstroAsciiData</code> v1.1 or greater (<a href="http://www.stecf.org/software/PYTHONtools/astroasciidata">http://www.stecf.org/software/PYTHONtools/astroasciidata</a>)</li>
</ul>
</li>
</ul>
<ul>
<li>Optional:<ul>
<li><code>GalSim</code> v1.x, if the <code>gbdsersic</code> <code>gbdshsersic</code> or <code>gcbdsersic</code> galaxy models are used</li>
<li><code>scdm</code> v0.6.x: if the Simple Coordinate Descent Minimizer (SCDM) is used</li>
<li><code>dwtwiener</code> v0.5.x: if uisng the dwtwiener denoising module (Nurbaeva et al., 2011, A&amp;A, <a href="http://www.aanda.org/articles/aa/full_html/2011/07/aa16556-11/aa16556-11.html">http://www.aanda.org/articles/aa/full_html/2011/07/aa16556-11/aa16556-11.html</a>)</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="Installation"></a>
Installation</h2>
<p>Download and untar the file <code>gfit-1.0.0.tar.gz</code> in the directory of your choice. The gfit executables are located in directory gfit-1.0.0/gfit.</p>
<h2><a class="anchor" id="Execution"></a>
Execution</h2>
<p>The general syntax is:</p>
<ul>
<li>SMP version: <div class="fragment"><pre class="fragment"> gfit_SMP.py [gfit options] 
</pre></div></li>
<li>MPI version: <div class="fragment"><pre class="fragment"> gfit_MPI.py [gfit options] 
</pre></div></li>
</ul>
<p>These executables are located in the installation directory under <code>gfit-0.7.5/gfit</code>. By default, gfit will look for a configuration file with default name <code>gfit.cfg</code>, located in the <code>./gfit/config directory</code>. These settings can be changed using the <code>-c</code> and <code>-d</code> options (see below).</p>
<p>The supported <code>gfit</code> options are:</p>
<div class="fragment"><pre class="fragment">
 -h, --help          Display the usage syntax and the list of supported options.

 -d, --config-dir    Directory where to find the configuration file (default: ./config)

 -c, --config-file   Name of the configuration file (default: gfit.cfg) 
</pre></div><p>To run <code><a class="el" href="gfit__MPI_8py.html">gfit_MPI.py</a></code>, one has to use the mpirun executable as:</p>
<div class="fragment"><pre class="fragment"> mpirun -np N gfit_MPI.py [gfit options]
</pre></div><p> or </p>
<div class="fragment"><pre class="fragment"> mpirun -np N python [python options] gfit_MPI.py [gfit options]
</pre></div><p>where <code>N</code> is the number of processors (or nodes) to use. <code>MPI</code> must has been installed and configured appropriately. On a cluster with a queuing system managed by a job scheduler, <code>mpirun</code> will have to be integrated in a shell script, invoked using a command like <code>qsub</code>.</p>
<p>Since the manager process of gfit uses one processor for itself, workers will share <code>N-1</code> processors.</p>
<p>For example: </p>
<div class="fragment"><pre class="fragment"> mpirun -np 6 gfit_MPI -d mydir -c myconfig.cfg 
</pre></div><p> will run <code>gfit</code> on 6 processors, 1 for the manager and 5 for the workers. The manager and each of the workers will look for a configuration <a href="file:">file:</a> <code>./mydir/myconfig.cfg </code>.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>Before running <code>gfit</code>, edit the configuration file to set the <code>BASE_INPUT_DIR</code> value, which should point to the directory where the <code>GREAT3</code> files reside. </dd>
<dd>
In the configuration file, any environment variable prefixed with <code>$</code> such as <code>$HOME</code> will be expanded when read.</dd></dl>
<h2><a class="anchor" id="gfit_config"></a>
Configuration</h2>
<p>The behaviour of <code>gfit</code> can be controlled though various configuration options located in its configuration file, <code>gfit.cfg</code> by default, in the <code>gfit/config</code> directory.</p>
<p>The format of the configuration file is similar to that of MS Windows&trade; .ini text files, with <code>sections</code> embedded within brackets, like <code>[section]</code>, each section containing a set of (<code>key</code>, <code>value</code>) pairs. The <code>.ini</code> format has been extended to support subsections and section inheritance. Configuration files are managed by the <code>sconfig</code> python module, wiich should be separately installed (see section <b>Prerequisites</b> above).</p>
<h3><a class="anchor" id="dirs"></a>
Directories</h3>
<p>The input, output and corrresponsing sub-directories are specified under the <code>[DIR]</code> section.</p>
<div class="fragment"><pre class="fragment">
# --- This section contains the directories from where gfit will read or store data                                  
[DIR]    

[DIR.INPUT]                            # base input directories: currently unused 
BASE_INPUT_DIR = ./input               # location of input objects to process     

[DIR.OUTPUT]                           # base output directories
BASE_OUTPUT_DIR = ./output             # where to store results, etc.
OUTPUT_PLOT_DIR   = plots              # where to save plots
OUTPUT_MAP_DIR    = maps               # where to save maps
OUTPUT_STAT_DIR   = stats              # where to record statistics
OUTPUT_LOG_DIR    = logs               # where to write logs
OUTPUT_RESULT_DIR = results            # where to write results of runs
OUTPUT_ERROR_DIR  = errors             # where to write errors during runs
</pre></div><p>Each time <code>gfit</code> is run, a directory of the form: <code>run_DD.MM.YY_HH.MM.SS.branch.obs_type.data_type</code> is created under the output directory specified by the key <code>BASE_OUTPUT_DIR</code> under the section <code>DIR.DIR_OUPUT</code>. The <code>branch</code>, <code>obs_type</code> and @ data_type components are named after the first capitalized letter of the branch, data type and observation types respectively.</p>
<p>For instance a run in the control-space-variable branch will have its data contained in a directory of the form <code>run_DD.MM.YY_HH.MM.SS.CSV</code>. Or for a run in both the variable_psf-space constant and the full-ground-variable branches, a directory like <code>run_DD.MM.YY_HH.MM.SS.VSC_FGV</code> will be created. The created directory will in turn contains the sub-directories <code>plots</code>, <code>maps</code>, <code>stats</code> <code>logs</code>, <code>results</code> and <code>errors</code>. The <code>plots</code>, <code>maps</code>, <code>stats</code> and <code>results</code> will have a directory tree-like structure that mimics the structure of the dataset.</p>
<p>The <code>DIR.INPUT</code> section is currently unused.</p>
<h3><a class="anchor" id="datasets"></a>
Datasets</h3>
<p>The <code></code>[DATASET] section specifies where input images, catalogs an other requred files to process are located. It also specifies Unix-like file matching patterns used to identify those files. At a minimum, a <code>dataset</code> has a name, a base directory and a a list of file matching patterns.</p>
<p>In this version <code>gfit</code> uses 3 datasets: one to access the <code>GREAT3</code> images, catalogs and other files, <code>SExtractor</code> galaxy and PSF catalog files and a <code>PSF</code> dataset with PSF images at the positions of galaxies. These datasets are described in more detail below.</p>
<h4><a class="anchor" id="g3_dataset"></a>
GREAT3 dataset</h4>
<p>The <code>GREAT3</code> dataset is identified by the <code>DATASET</code> section:</p>
<div class="fragment"><pre class="fragment">
# --- Main source dataset, in this case GREAT3
[DATASET]                        # note: cannot process both deep and normal images in the same run

NAME = great3                    # name of dataset to use
BASE_DIR = $HOME/GREAT3          # dataset base input directory

# --- gfit needs galaxy images and catalogs
FILE_PATTERNS = ["image*.fits", "galaxy_catalog*"]  
                                                    
# Note: to process deep images, use: FILE_PATTERNS = ["deep_image*", "deep_galaxy_catalog*"]
 
# --- Search criteria, branches: ["control", "real_galaxy", "variable_psf", "multiepoch", "full"]
BRANCHES   = ["control"]               

# --- Observation type: ["ground", "space"]
OBS_TYPES  = ["ground"]             
                           
# --- Data type: ["constant", "variable"]                                           
DATA_TYPES = ["constant"]  

# --- Set of Image numbers (use [] to process all images (IMAGE_LIST has priority over IMAGE_RANGE) 
IMAGE_LIST  = [0]                   
                                    
# --- [Min,Max] image number range (-1 or [] to disable criterion)       
IMAGE_RANGE = []    

# --- Actual Galaxy stamp size to use for shape measurement
GALAXY_EFFECTIVE_STAMP_SIZE = {"control":{"ground":26, "space":54},\
                                "multiepoch":{"ground":44, "space":44},\
                                "variable_psf":{"ground":44, "space":88},\
                                "real_galaxy":{"ground":44, "space":88},\
                                "full":{"ground":44, "space":88}\
                              }          

# --- Actual PSF stamp size to use for shape measurement
PSF_EFFECTIVE_STAMP_SIZE = {"control":{"ground":26, "space":54},\
                             "multiepoch":{"ground":44, "space":44},\
                             "variable_psf":{"ground":44, "space":88},\
                             "real_galaxy":{"ground":44, "space":88},\
                             "full":{"ground":44, "space":88}\
                           }  
</pre></div><p>The <code>BASE_DIR</code> key specifies where the base <code>GREAT3</code> directories are located, i.e. where the branch directories (<code>control</code>, <code>real_galaxy</code>, <code>multiepoch</code>, etc.) are to be read from.</p>
<p>The <code>FILE_PATTERNS</code> key contains a list of pattern matching strings, used to identify which files are collectively needed to perform shape measurement. A set of such files is processed by <code>gfit</code> as a <code>job</code>. For instance, in the context of <code>GREAT3</code>, a job will contain all files related to image <code>000</code> in the <code>control-ground-constant</code> branch tree: <code>image-000.0.fits</code> and <code>galaxy_catalog-000.fits</code>. On a multiprocessor machine or cluster, each job will be assigned to one processor.</p>
<p>The <code>BRANCHES</code>, <code>OBS_TYPE</code> and <code>DATA_TYPE</code> keys respectively specify the lists of branches (e.g. "control"), observation types (e.g. "ground", "space") and data types (e.g. "constant", "variable") to process.</p>
<p>The <code>IMAGE_LIST</code> key is a list of image numbers to process, like for instance <code>[0, 10, 67]</code>. An empty list <code>[]</code> indicates that <em>all</em> images in the underlying branch, observation type and data type have to be processed.</p>
<p>The <code>IMAGE_RANGE</code> key specifies a range of image numbers to process. for instance, [1, 50] will have <code>gfit</code> access all images from 1 to 50, 1 and 50 included. Note that the <code>IMAGE_LIST</code> has priority other <code>IMAGE_RANGE</code>: the image range will be ignored unless <code>IMAGE_RANGE=[]</code>.</p>
<p>The <code>GALAXY_EFFECTIVE_STAMP_SIZE</code> and <code>PSF_EFFECTIVE_STAMP_SIZE</code> keys respectively control the sizes of the postage stamps to cut-out from galaxy and PSF images. <code>gfit</code> will estimate the centroid of the postage stamp image and cut-out a stamp with the specified size. Note that since most centroids are shifted by 1 or more pixels, cutting-out a square stamp of the exact size specified in <code>GALAXY_EFFECTIVE_STAMP_SIZE</code> and <code>PSF_EFFECTIVE_STAMP_SIZE</code> may not be possible. In such cases, <code>gfit</code> will automatically reduce the size of the stamp to the maximum possible size. A warning will be issued in the log file for that image.</p>
<h4><a class="anchor" id="se_dataset"></a>
SEXtractor dataset</h4>
<p>The <code>SExtractor</code> dataset, <code>[SEXTRACTOR_DATASET]</code>, points to the location of SExtractor catalogs. These catalogs have been generated beforehand for every galaxy and PSF image using the <code>pse</code> "Parallel SExtractor" utility (M. Gentile, 2011-2013). <code>gfit</code> makes use of these catalogs to provide guess values of object centroids, fluxes and half-light radii to the minimizer prior to fitting.</p>
<div class="fragment"><pre class="fragment">
[SEXTRACTOR_DATASET]

# --- gfit needs to access galaxy catalogs created by SEXtractor
[SEXTRACTOR_DATASET.GALAXY]         
NAME = gal_sextractor                      
BASE_DIR = $HOME/mg-dev/trunk/pse_package/pse/completed_runs/run_gal_19.11.2013/results
FILE_PATTERNS = ["image*.cat"]   

# Note: to process deep images, use: FILE_PATTERNS = ["deep_image*.cat"]

# --- gfit needs to access star catalogs created by SEXtractor
[SEXTRACTOR_DATASET.PSF]
NAME = psf_sextractor                      
BASE_DIR = $HOME/mg-dev/trunk/pse_package/pse/completed_runs/run_psf_21.11.2013/results
FILE_PATTERNS = ["starfield*.cat"]

# Note: to process deep images, use: FILE_PATTERNS = ["deep_starfield*.cat"]   
</pre></div><h4><a class="anchor" id="psf_dataset"></a>
PSF dataset</h4>
<p>The <code>PSF</code> dataset specifies the location the PSF images interpolated at the positions of galaxies. In the case of <code>GREAT3</code> constant PSF branches, it contains only the images of the PSF centered at coordinates <code>(0, 0)</code> in the <code>starfields_image-*-*</code>.fits images (the PSF that is centered). For the "variable_PSF" branch, it contains images similar to starfield images (<code>10000</code> postage stamps on a grid).</p>
<div class="fragment"><pre class="fragment">
# --- PSF dataset (PSFs at galaxy positions)
[PSF_DATASET]
NAME = psf 
BASE_DIR = $HOME/mg-dev/trunk/mkpsf_package/mkp/completed_runs/run_21.11.2013/results
FILE_PATTERNS = ["starfield*.fits"]  # or  ["deep_starfield*.cat"] 
#FILE_PATTERNS = ["deep_starfTrueield*.fits"]
</pre></div><h3><a class="anchor" id="img_properties"></a>
Image properties</h3>
<p>The <code>[IMAGE_PROPERTIES]</code> section details a few important image properties required by <code>gfit</code>.</p>
<div class="fragment"><pre class="fragment">
[IMAGE_PROPERTIES]

[IMAGE_PROPERTIES.GALAXY]
PIXEL_FLOAT_SIZE = float32             # size of float for pixel values 
IMAGE_HDU_NO = 0                       # HDU no corresponding to the image data
CATALOG_HDU_NO = 1                     # HDU no corresponding to the catalog data
CATALOG_EXTENSION = .fits              # ".txt" or ".fits"

[IMAGE_PROPERTIES.PSF]
PIXEL_FLOAT_SIZE = float32             # size of float for pixel values 
IMAGE_HDU_NO = 0                       # HDU no corresponding to the image data
CATALOG_HDU_NO = 1                     # HDU no corresponding to the catalog data
CATALOG_EXTENSION = .fits              # ".txt" or ".fits"
</pre></div><p>The <code>[CATALOG_EXTENSION]</code> is required because the <code>GREAT3</code> dataset contains star and galaxy catalogs in both .txt and .fits format.</p>
<h3><a class="anchor" id="fitting"></a>
Galaxy Fitting</h3>
<p>The main purpose of <code>[GALAXY_FITTING]</code> section is to indicate which galaxy model and fitting method to use. <code>gfit</code> currently supports the <code>scsersic</code>, <code>gbdsersic</code>, and <code>gcbdsersic</code> galaxy models already mentioned.</p>
<p>Two minimizers are available in ths version as mentioned before: <code>scileastsq</code> and <code>scdmin</code>.</p>
<div class="fragment"><pre class="fragment">
# --- Galaxy fitting                          
[GALAXY_FITTING]

GALAXY_MODEL_NAME     = gbdsersic      # among: [scsersic, gbdsersic, gbdshsersic, gcbdsersic]
GALAXY_FITTING_METHOD = scdmin         # among: [scileastsq, scdmin]
</pre></div><h3><a class="anchor" id="multifit"></a>
Multifit</h3>
<p>The <code>Multifit</code> Python module provides <code>gfit</code> with a unified interface to galaxy models and fitting methods. This makes the <code>gfit</code> code independent of a particular galaxy model or minimizer.</p>
<p>The <code>[MULTIFIT]</code> section specifies where the models and fitting methods configuration files are located. It also indicates from where the corresponding python modules can be dynamically loaded.</p>
<div class="fragment"><pre class="fragment">
# --- Multifit module
[MULTIFIT]
MODEL_CONFIG_PATH   = ./config/models             # path to multifit configuration files for models
METHOD_CONFIG_PATH  = ./config/methods            # path to multifit configuration files for methods 
FITTING_CONFIG_PATH = ./config/methods            # path to multifit configuration files for methods 

MODEL_MODULE_PATH  = $MFIT_DIR/modules/models     # path to multifit modules of fitting models
METHOD_MODULE_PATH = $MFIT_DIR/modules/methods    # path to multifit modules of fitting methods
</pre></div><h3><a class="anchor" id="shape"></a>
Shape measurement</h3>
<p>The <code>[SHAPE_MEASUREMENT]</code> controls the shape measurement operation.</p>
<div class="fragment"><pre class="fragment">
[SHAPE_MEASUREMENT] 
NORMALIZE_PSF = True                   # if True, normalize the PSF image before convolution
SUBSTRACT_GALAXY_SKY = False           # if True estimate and remove the sky noise in galaxy images
SUBSTRACT_PSF_SKY = False              # if True estimate and remove the sky noise in PSF images
FAILED_ELLIPTICITY_VALUE = 10.0        # if -1,.0 take the value of the fit, even though it failed
GALAXY__SUBSCALE = 1                   # resolution of constructed galaxy models
</pre></div><p>The key <code>FAILED_ELLIPTICITY_VALUE</code> sets the value of ellipticity used to flag wrong fits in the results submission files produced for each processed image. The <code>GREAT3</code> presubmission script will ignore entries with ellipticity values greater than or equal to <code>10</code>. If set to <code>-1</code>, <code>gfit</code> will not flag entries with bad fits. This is not recommended.</p>
<p>Note that <code>gfit</code> also always produce, for each image, a result submission file that includes <em>all</em> fits either good or bad. So the preferred approach is to choose <code>FAILED_ELLIPTICITY_VALUE = 10.0</code>.</p>
<p>The results files for submission are stored in the directory specified in the <code>OUTPUT_RESULT_DIR</code> key in the <code>[DIR.OUTPUT]</code> section. Their names are of the form: <code>"results_branch_obs_type_data_type-img_no.txt"</code>, for instance <code>"results_control_ground_constant-000.txt"</code>. The "full" results file containing all the fits is prefixed by <code>full</code>, like <code>"full_results_control_ground_constant-000.txt"</code>.</p>
<p>Lastly, <code>gfit</code> also produces for each processed image a files containing only the bad fits. These files are stored in the directory pointed by the <code>OUTPUT_ERROR_DIR</code> key in the <code>[DIR.OUTPUT]</code> section.</p>
<h3><a class="anchor" id="denoising"></a>
Denoising</h3>
<p>The <code>[DENOISING]</code> section is intended to include any denoising scheme that may be applied to each postage stamp.</p>
<p>In this version, <code>gfit</code> only supports the DWT Wiener wavelet-based denoising algorithm from Nurbaeva et al., 2011, whose settings can be set in the <code>[DENOISING.DWTWIENER]</code> section.</p>
<div class="fragment"><pre class="fragment">
[DENOISING]

[DENOISING.DWTWIENER]                  # Denoising with dwtwiener (Nurbaeva et al., A&amp;A, 2011)

[DENOISING.DWTWIENER.GALAXY]
APPLY_DWTWIENER = False                # if True apply dwtwiener to denoise the images
DECOMPOSITION_LEVEL = 2                # decomposition level (from l=1, default l=2)
CYCLE_SPINNING = False                 # if True, use cycle spinning
SIGMA_NOISE =-1                        # noise standard deviation (estimated if set to -1)
DENOISING_STRENGTH = 0.6               # denoising strength fron 0 to 1
</pre></div><h3><a class="anchor" id="collect"></a>
Data collection</h3>
<p>The <code>[DATA_COLLECTION]</code> section relates to extra data that can e.g. be collected to help diagnose problems, improve gfit's performance, perform training for bias correction, etc.</p>
<div class="fragment"><pre class="fragment">
[DATA_COLLECTION]

COLLECT_DATA = True                    # if True collect shape measurement data, besides parameters
DUMP_COLLECTED_DATA = True             # if True, create a catalog with collected data per image
PLOT_COLLECTED_DATA = True             # it True, plot collected data per image
</pre></div><p><code>gfit</code> will always record fitted parameters values and will allow to dump, plot or map these.</p>
<p>Additionally, if <code>COLLECT_ERROR_DATA</code> is set to <code>True</code>, <code>gfit</code> will collect additional data besides fitted parameters, such as <code>SExtractor</code> data (from SExtrator catalogs) and statistics on residuals.</p>
<p>If <code>PLOT_COLLECTED_DATA</code> is set to <code>True</code>, fitted parameter data and possibly extra data collected if <code>COLLECT_DATA=True</code> will be plotted and stored in the directory specified by key <code>OUTPUT_PLOT_DIR</code> in section <code>[DIR.OUTPUT]</code>. Otherwise, no plot will be made.</p>
<p>If <code>DUMP_COLLECTED_DATA</code> is set to true, fitted parameter data and extra data collected if <code>COLLECT_DATA=True</code> will dumped to a file with name of the form "data_branch_obs_type_data_type-img_no.txt", like for example "data_control_ground_constant-000.txt". The file will be stored in the directory specified in the <code>OUTPUT_RESULT_DIR</code> key in the <code>[DIR.OUTPUT]</code> section. Otherwise, no file will be created.</p>
<h3><a class="anchor" id="filtering"></a>
Object Filtering</h3>
<p>This section provides a way to filter-out of "clean" unwanted objects, i.e. galaxies or stars. A filtering criterion takes the form of a range of allowed values, like <code>[0, 600]</code>. The value <code>None</code> denotes that there is no lower or upper bound. For instance, <code>[0, None]</code> allows for values greater than zero, with no upper limit.</p>
<p>Filtering takes place <em>before</em> fitting ("pre-filtering") or <em>after</em> ("post-filtering").</p>
<ul>
<li>In this version, pre-filtering is applied on selected SExtractor catalog keywords. The name of the criterion is the name of the SExtractor keyword prefixed by <code>"SE_"</code>, like <code>SE_FLUX_RADIUS</code>.</li>
<li>Post-filtering can currently be done on the sum of the residuals between observed and built model, normalized by the total number of pixels in the postage stamp used for fitting.</li>
</ul>
<p>The keyword <code>FILTERING_POLICY</code> specifies what should be done with the "filtered" objects. In this version, objects are effectively "removed" from the final object catalog (<code>FILTERING_POLICY = remove</code>). A future version may allow to ascribe a weighting factor to filtered objects instead of removing them.</p>
<p>Filtering can be enabled or disabled by specifying <code>ENABLE_FILTERING=True</code> or <code>ENABLE_FILTERING=False</code>. If filtering is enabled, a catalog with un-filtered objects will still be produced in order to better investigate the effect of filtering.</p>
<div class="fragment"><pre class="fragment">
[OBJECT_FILTERING]

# --- Galaxy ---
[OBJECT_FILTERING.GALAXY]

ENABLE_FILTERING = True    # set to True to enable galaxy filtering
FILTERING_POLICY = remove  # how to handle filtered data, among: [remove, weight]

FILTER = {"SE_HLR" : [0, None],\     # allowed SExtractor FLUX_RADIUS range
          "SE_FWHM_IMAGE"  : [0, None],\     # allowed SExtractor FWHM_IMAGE range
          "SE_FLUX"        : [0, None],\     # allowed SExtractor FLUX_BEST range
          "SE_MAG"         : [None, None],\  # allowed SExtractor MAG_BEST range
          "SE_SNR"         : [0, None],\     # allowed SExtractor SNR (FLUX_BEST/FLUXERR_BEST)
          "NORM_RESIDUALS" : [0, None] \     # allowed range of normalized sum of residuals
         }         

# --- PSF ---
[OBJECT_FILTERING.PSF]

ENABLE_FILTERING = False   # set to True to enable PSF filtering
FILTERING_POLICY = remove  # how to handle filtered data, among: [remove, weight]

FILTER = {"SE_HLR"         : [0, None],\     # allowed SExtractor FLUX_RADIUS range
          "SE_FWHM_IMAGE"  : [0, None],\     # allowed SExtractor FWHM_IMAGE range
          "SE_FLUX"        : [0, None],\     # allowed SExtractor FLUX_BEST range
          "SE_MAG"         : [None, None],\  # allowed SExtractor MAG_BEST range
          "SE_SNR"         : [0, None],\     # allowed SExtractor SNR (FLUX_BEST/FLUXERR_BEST)
          "NORM_RESIDUALS" : [0, None] \     # allowed range of normalized sum of residuals
         } 
</pre></div><h3><a class="anchor" id="logging"></a>
Logging</h3>
<p>The <code>[LOGGING]</code> section tells if logging is enabled, and which logging mode is used.</p>
<div class="fragment"><pre class="fragment">
[LOGGING]
MASTER_LOGGING_ENABLED = True          # quiet mode if set to False
CREATE_WORKER_LOGGERS = per_job        # among: {none, per_job, per_worker}
</pre></div><p>If the <code>MASTER_LOGGING_ENABLED</code> key value is set to False, no display output nor file logging will be done.</p>
<p>In the case <code>MASTER_LOGGING_ENABLED=True</code>, if the <code>CREATE_WORKER_LOGGERS</code> key value is set to <code>none</code>, then no log file will be created for workers.</p>
<p>If not <code>none</code>, the <code>CREATE_WORKER_LOGGERS</code> key specifies two logging modes: <code>per_job</code> and <code>per_worker</code>. In the <code>per_job</code> mode, one log file will be created for each job processed (i.e. each <code>GREAT3</code> image). In the <code>per_worker</code> mode, one log file will be created for each worker, not for each image, so the worker's log will trace the shear measurement output of all the images processed by a particular worker.</p>
<h3><a class="anchor" id="debugging"></a>
Debugging</h3>
<p>The <code>[DEBUGGING]</code> section controls the amount and type of debugging information.</p>
<div class="fragment"><pre class="fragment">
[DEBUGGING]

MAX_NB_STAMPS = 5                       # maximum number of stamps to process (-1: all) 

EXTRACT_GALAXY_STAMPS = True            # if True, write individual galaxy stamps as .FITS
EXTRACT_CONVOLVED_GALAXY_STAMPS = False # if true, write individual convolved galaxy stamps as .FITS
EXTRACT_GALAXY_RESIDUALS = False        # if True, extract galaxy residuals after fitting
EXTRACT_PSF_STAMPS = False              # if True, write individual PSF stamps as .FITS files
CREATE_CONVOLVED_GALAXY_MOSAIC = True   # if True, create a convolved stamp mosaic
CREATE_RESIDUALS_GALAXY_MOSAIC = True   # if True, create a convolved stamp mosaic
MOSAIC_STAMP_SIZE = 48                  # stamp size in generated mosaic

PLOT_GALAXY_STAMPS = True               # if True, plot individual galaxy stamps
PLOT_CONVOLVED_GALAXY_STAMPS = False    # if True, plot individual convolved galaxy stamps 
PLOT_GALAXY_RESIDUALS = False           # if True, plot galaxy residuals after fitting
PLOT_PSF_STAMPS = False                 # True to plot individual PSF stamps
PLOT_ENABLE_3D = True                   # if True, also plot in 3D

RECORD_FAILED_FITS = True               # Keep a copy of the galaxy stamp in the errors directory

PROGRESS_COUNT = 5                      # display progress every &lt;PROGRESS_COUNT&gt; galaxies
</pre></div><p>The number of postage stamps to fit within an image is set by the <code>MAX_NB_STAMPS</code>. A value of <code>-1</code> means that <em>all</em> postage stamps will be processed. otherwise, <code>gfit</code> will process the <em>first</em> number of stamps specified in <code>MAX_NB_STAMPS</code>. The sorting order is y then x, so <code>gfit</code> will proceed row after row in an image, processing each column of a given row.</p>
<p>The <code>EXTRACT_GALAXY_STAMPS</code>, <code>EXTRACT_CONVOLVED_GALAXY_STAMPS</code>, <code>EXTRACT_GALAXY_RESIDUALS</code>, <code>EXTRACT_PSF_STAMPS</code> boolean flags tell whether postage stamps should be extracted as .FITS files for observed galaxies, convolved galaxies, galaxy residuals and observed PSFs, in this order. The target directory is that specified as <code>OUTPUT_RESULT_DIR</code> in section <code>[DIR.OUTPUT]</code>.</p>
<p>If <code>CREATE_CONVOLVED_GALAXY_MOSAIC</code> is <code>True</code>, <code>gfit</code> will create a mosaic containing the best-fitted convolved galaxy models inside postage stamps of size set by <code>MOSAIC_STAMP_SIZE</code>. The coordinate of galaxies within the mosaic will be the same as in the source image and catalog. Failed fits are indicated by a postage stamp with zero pixel values at the corresponding coordinates.<br/>
 Similarly, if <code>CREATE_RESIDUALS_GALAXY_MOSAIC</code> is set to <code>True</code>, a mosaic of the residuals postage stamps will also be created, where residual postage stamps are the difference between observed galaxies and model-convolved galaxies.<br/>
 Note that, in practice, most postage stamps will have an effective size smaller than the specified mosaic stamp size (e.g. 44 instead of <code>MOSAIC_STAMP_SIZE = 48) </code>. Such stamps will be aligned on the bottom-left corner of the mosaic stamp.</p>
<p>The <code>PLOT_GALAXY_STAMPS</code>, <code>PLOT_CONVOLVED_GALAXY_STAMPS</code>, <code>PLOT_GALAXY_RESIDUALS</code> and <code>PLOT_PSF_STAMPS</code> specify whether postage stamps should be plotted for observed galaxies, convolved galaxies, galaxy residuals and observed PSFs, in this order. The target directory is that specified as <code>OUTPUT_PLOT_DIR</code> in section <code>[DIR.OUTPUT]</code>. If <code>PLOT_ENABLE_3D</code> is set to <code>True</code>, three-dimensional plots are also drawn.</p>
<p>The <code>RECORD_FAILED_FITS</code> flag indicates if postrage stamps for which the fit failed should be stored for later investigation in the directory pointed by <code>OUTPUT_ERROR_DIR</code> in section <code>[DIR.OUTPUT]</code>.</p>
<p><code>PROGRESS_COUNT</code> specifies how often <code>gfit</code> should display or log output information. For instance, a value of <code>10</code> will output every time <code>10</code> postage stamp images have been fitted.</p>
<h3><a class="anchor" id="multiproc"></a>
SMP Multiprocessing</h3>
<p>The <code>[MULTIPROC_SMP]</code> only concerns the <code>SMP</code> version of <code>gfit</code> and tells how many processors should be allocated through the <code>WORKER_PROCESSES_COUNT</code> key. A value of <code>-1</code> let the system decide the optimal number of processors to use.</p>
<div class="fragment"><pre class="fragment">
[MULTIPROC_SMP]
WORKER_PROCESSES_COUNT = 0   # nb. worker processes for SMP (0 automatic detection, &gt; 0 otherwise)
</pre></div><h2><a class="anchor" id="multifit_config"></a>
Multifit configuration</h2>
<p><code>gfit</code> interacts with the Multifit module through a set of configuration files. There are configuration files for fitting methods and for parametric models.</p>
<h3><a class="anchor" id="model_config"></a>
Galaxy Model configuration</h3>
<p>A Multifit configuration file is present for each supported galaxy model and bear the same name as that of the model. Thus, there are <code>3</code> model configuration files in this version of <code>gfit:</code> </p>
<ul>
<li><code>scsersic.cfg</code> for the single Sérsic component model</li>
<li><code>gbdsersic.cfg</code> for the bulge+disk model</li>
<li><code>gcbdsersic.cfg</code> for the "complex" bulge+disk model</li>
</ul>
<p>For each galaxy model, the list of model parameters is given, specifing the name of each parameter, its guess value and its bounds (min and max alowed values).</p>
<h3><a class="anchor" id="method_config"></a>
Fitting Method configuration</h3>
<p>A Multifit configuration file is also present for each supported fitting method and bear the same name as that of the method. Since <code>2</code> minimizers are supported in this version, there are also <code>2</code> configuration files:</p>
<ul>
<li><code>scdmin.cfg</code> for the <code>SCDM</code> minimizer</li>
<li><code>scileastsq.cfg</code> for the <code>Levenberg-Marquardt</code> non-linear least-squares implementation available with <code>SciPy</code>.</li>
</ul>
<p>Sometimes, it is mecessary to provide fitting information that is common to both the model and the method. This is the case for the <code>SCDM</code> minimizer, which uses such information for optimizing the fitting process. For instance one can specify the initial step value to fit a given parameter. Such extra fitting information can be kept in a file prefixed by the minimizer name and suffixed by <code>"_fitting"</code>. In the case of SCDM, known as <code>scdmin</code> by <code>gfit</code>, the fitting configuration file is <code>scdmin_fitting.cfg</code>. It contains extra fitting information for each galaxy model. </p>
</div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="footer">Generated on Tue Apr 21 2015 14:26:30 for gfit by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
